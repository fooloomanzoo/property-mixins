<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1, initial-scale=1, user-scalable=yes">

    <title>number-format-mixin test</title>

    <script src="../../webcomponentsjs/webcomponents-loader.js"></script>
    <script src="../../web-component-tester/browser.js"></script>
    <script src="../../iron-test-helpers/test-helpers.js"></script>
    <link rel="import" href="../../polymer/polymer.html">

    <link rel="import" href="../demo/elements/basic-range-element.html">
  </head>
  <body>

    <test-fixture id="basic">
      <template>
        <basic-range-element></basic-range-element>
      </template>
    </test-fixture>

    <test-fixture id="negative zero">
      <template>
        <basic-range-element use-negative-zero step="1"></basic-range-element>
      </template>
    </test-fixture>

    <dom-bind id="domBind1">
      <template>
        <basic-range-element id="range1" value-as-number="{{value}}" use-negative-zero></basic-range-element>
        <basic-range-element id="range2" value-as-number="{{value}}" use-negative-zero></basic-range-element>
      </template>
    </dom-bind>

    <test-fixture id="min">
      <template>
        <basic-range-element min="2" value-as-number="-1"></basic-range-element>
      </template>
    </test-fixture>

    <test-fixture id="max">
      <template>
        <basic-range-element max="2" value-as-number="3"></basic-range-element>
      </template>
    </test-fixture>

    <test-fixture id="min-max-switched">
      <template>
        <basic-range-element min="3" max="-1"></basic-range-element>
      </template>
    </test-fixture>

    <test-fixture id="step">
      <template>
        <basic-range-element step="12"></basic-range-element>
      </template>
    </test-fixture>

    <test-fixture id="clamp">
      <template>
        <basic-range-element step="0.5" value-as-number="1.24"></basic-range-element>
      </template>
    </test-fixture>

    <test-fixture id="no clamp">
      <template>
        <basic-range-element step="0.5" value-as-number="1.25" no-clamp></basic-range-element>
      </template>
    </test-fixture>

    <test-fixture id="no saturation">
      <template>
        <basic-range-element min="-2" max="2" ></basic-range-element>
      </template>
    </test-fixture>

    <test-fixture id="saturate">
      <template>
        <basic-range-element min="-2" max="2" saturate></basic-range-element>
      </template>
    </test-fixture>

    <script>
      const specifier = new URLSearchParams(window.location.search).get('specifier');
      const url = new URLSearchParams(window.location.search).get('url');

      // applying suites to another element (e.g. when another element depends on the the same mixin)
      if (specifier) {
        suite(`Suite for ${specifier.toUpperCase()}`, function() {
          test('loading dependencies', done => {
            Polymer.importHref(url, e => done(), e => {
              console.warn(`failed to load: ${url}`)
            })
          })
        })
      }

      suite('basic', () => {
        let element;

        setup(function() {
          if (specifier) {
            replace('basic-range-element').with(specifier)
          }
          element = fixture('basic');
        });

        test('default properties', done => {
          assert.isUndefined(element.min, 'min is not defined');
          assert.isUndefined(element.max, 'max is not defined');
          assert.isUndefined(element.step, 'step is not defined');
          assert.isUndefined(element.valueAsNumber, 'valueAsNumber is not defined');
          assert.isUndefined(element.default, 'default is not defined');
          assert.isUndefined(element.saturate, 'saturate is not defined');
          assert.isUndefined(element.noClamp, 'noClamp is not defined');
          assert.isUndefined(element.startAt, 'startAt is not defined');
          done();
        });

        test('setting default', done => {
          element.default = 3;
          assert.equal(element.valueAsNumber, 3, 'valueAsNumber should be set');
          element.valueAsNumber = undefined;
          assert.equal(element.valueAsNumber, 3, 'valueAsNumber should be reset');
          done();
        });

        test('start at value', done => {
          element.startAt = 3;
          element.increase();
          assert.equal(element.valueAsNumber, 3, 'valueAsNumber should use startAt');
          done();
        });

        test('increase with no step set', done => {
          element.default = element.startAt = 3;
          element.increase();
          assert.equal(element.valueAsNumber, 4, 'valueAsNumber should use increment');
          done();
        });

        test('decrease with no step set', done => {
          element.default = element.startAt = 3;
          element.decrease();
          assert.equal(element.valueAsNumber, 2, 'valueAsNumber should use decrease');
          done();
        });

        test('increase', done => {
          element.step = 12;
          element.default = element.startAt = 3;
          element.increase();
          assert.equal(element.valueAsNumber, 15, 'valueAsNumber should use increment');
          done();
        });

        test('decrease', done => {
          element.step = 12;
          element.default = element.startAt = 3;
          element.decrease();
          assert.equal(element.valueAsNumber, -9, 'valueAsNumber should use decrease');
          done();
        });

        test('increase (no clamp)', done => {
          element.noClamp = true;
          element.step = 12;
          element.valueAsNumber = 3;
          element.increase();
          assert.equal(element.valueAsNumber, 15, 'valueAsNumber should use increment');
          done();
        });

      });

      suite('negative zero', () => {
        let element;

        setup(function() {
          if (specifier) {
            replace('basic-range-element').with(specifier)
          }
          element = fixture('negative zero');
        });

        test('from 1 to +0', done => {
          element.valueAsNumber = 1;
          element.decrease();
          assert.isTrue(!numberUtilities.isNegative0(element.valueAsNumber) && element.valueAsNumber === 0, 'valueAsNumber decrease to positive zero');
          done();
        });

        test('from +0 to -0', done => {
          element.valueAsNumber = 0;
          element.decrease();
          assert.isTrue(numberUtilities.isNegative0(element.valueAsNumber), 'valueAsNumber should be negative zero'+element.valueAsNumber);
          done();
        });

        test('from 1 to -0', done => {
          element.valueAsNumber = 1;
          element.decrease();
          element.decrease();
          assert.isTrue(numberUtilities.isNegative0(element.valueAsNumber), 'valueAsNumber should be negative zero'+element.valueAsNumber);
          done();
        });

        test('from -0 to -1', done => {
          element.valueAsNumber = -0;
          element.decrease();
          assert.equal(element.valueAsNumber, -1, 'valueAsNumber should decrease from negative zero');
          done();
        });

        test('from -1 to -0', done => {
          element.valueAsNumber = -1;
          element.increase();
          assert.isTrue(numberUtilities.isNegative0(element.valueAsNumber), 'valueAsNumber should increase to negative zero'+element.valueAsNumber);
          done();
        });

        test('from -0 to +0', done => {
          element.valueAsNumber = -0;
          element.increase();
          assert.isTrue(!numberUtilities.isNegative0(element.valueAsNumber) && element.valueAsNumber === 0, 'valueAsNumber should increase to positive zero' + element.valueAsNumber);
          done();
        });

        test('from +0 to 1', done => {
          element.valueAsNumber = 0;
          element.increase();
          assert.equal(element.valueAsNumber, 1, 'valueAsNumber should increase from positive zero');
          done();
        });

        test('multiple', done => {
          element.valueAsNumber = -2;
          for (var i = 0; i < 5; i++) {
            element.increase();
          }
          assert.equal(element.valueAsNumber, 2, 'valueAsNumber should increase over zero');
          for (var i = 0; i < 5; i++) {
            element.decrease();
          }
          assert.equal(element.valueAsNumber, -2, 'valueAsNumber should decrease back over zero');
          done();
        });
      });

      suite('dom-bind', () => {
        let dombind,
          el1,
          el2;

        setup( () => {
          if (specifier) {
            replace('basic-range-element').with(specifier)
          }
          dombind = document.querySelector('#domBind1');
          el1 = dombind.$.range1;
          el2 = dombind.$.range2;
          dombind.value = undefined;
          el1.valueAsNumber = undefined;
          el2.valueAsNumber = undefined;
        })

        test('propagate negative zero change to positive zero', done => {
          el1.valueAsNumber = -0

          assert.isTrue(numberUtilities.isNegative0(el1.valueAsNumber), 'value of first element is set to -0');
          assert.isTrue(numberUtilities.isNegative0(el2.valueAsNumber), 'value of second element is set to -0');

          el1.valueAsNumber = 0;
          assert.isTrue(!numberUtilities.isNegative0(el1.valueAsNumber) && el1.valueAsNumber === 0, 'value of first element is set to +0');
          assert.isTrue(!numberUtilities.isNegative0(el2.valueAsNumber) && el2.valueAsNumber === 0, 'value of second element is set to +0');
          done();
        });

        test('propagate negative zero change to positive zero with default values', done => {
          el1.default = 1;
          el2.default = 2;

          el1.valueAsNumber = -0

          assert.isTrue(numberUtilities.isNegative0(el1.valueAsNumber), 'value of first element is set to -0');
          assert.isTrue(numberUtilities.isNegative0(el2.valueAsNumber), 'value of second element is set to -0');

          el1.valueAsNumber = 0;
          assert.isTrue(!numberUtilities.isNegative0(el1.valueAsNumber) && el1.valueAsNumber === 0, 'value of first element is set to +0');
          assert.isTrue(!numberUtilities.isNegative0(el2.valueAsNumber) && el2.valueAsNumber === 0, 'value of second element is set to +0');
          done();
        });
      });

      suite('min', () => {
        let element;

        setup(function() {
          if (specifier) {
            replace('basic-range-element').with(specifier)
          }
          element = fixture('min');
        });

        test('setting min', done => {
          assert.equal(element.min, 2, 'min is set');
          assert.equal(element.valueAsNumber, element.min, 'value is set to min');
          done();
        });
      });

      suite('max', () => {
        let element;

        setup(function() {
          if (specifier) {
            replace('basic-range-element').with(specifier)
          }
          element = fixture('max');
        });

        test('setting max', done => {
          assert.equal(element.max, 2, 'max is set');
          assert.equal(element.valueAsNumber, element.max, 'value is set to max');
          done();
        });
      });

      suite('min-max-switched', () => {
        let element;

        setup(function() {
          if (specifier) {
            replace('basic-range-element').with(specifier)
          }
          element = fixture('min-max-switched');
        });

        test('min is higher than max', done => {
          assert.equal(element.max, 3, 'max should switch');
          assert.equal(element.min, -1, 'min should switch');
          done();
        });
      });

      suite('clamp', () => {
        let element;

        setup(function() {
          if (specifier) {
            replace('basic-range-element').with(specifier)
          }
          element = fixture('clamp');
        });

        test('clamp value', done => {
          assert.equal(element.valueAsNumber, 1, 'value should clamp');
          done();
        });
        test('clamp value', done => {
          assert.equal(element.valueAsNumber, 1, 'value should clamp');
          done();
        });
      });

      suite('no clamp', () => {
        let element;

        setup(function() {
          if (specifier) {
            replace('basic-range-element').with(specifier)
          }
          element = fixture('no clamp');
        });

        test('clamp value', done => {
          assert.equal(element.valueAsNumber, 1.25, 'value should not clamp');
          done();
        });
      });

      suite('saturation', () => {
        let element;

        setup(function() {
          if (specifier) {
            replace('basic-range-element').with(specifier)
          }
          element = fixture('saturate');
        })

        test('saturate value', done => {
          element.valueAsNumber = 2;
          element.valueAsNumber = 5;
          assert.equal(element.valueAsNumber, 2, 'value should saturate');
          element.valueAsNumber = -2;
          element.valueAsNumber = -5;
          assert.equal(element.valueAsNumber, -2, 'value should saturate');
          done();
        });

        test('do not saturate value', done => {
          let element = fixture('no saturation');
          element.valueAsNumber = 2;
          element.valueAsNumber = 5;
          assert.equal(element.valueAsNumber, -2, 'value should not saturate');
          element.valueAsNumber = -2;
          element.valueAsNumber = -5;
          assert.equal(element.valueAsNumber, 2, 'value should not saturate');
          done();
        });
      });
    </script>

  </body>
</html>
